<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šçº¿ç¨‹ä¸å¹¶å‘</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="../i18n.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .back-btn {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            margin-bottom: 20px;
        }
        .control-panel { text-align: center; margin-bottom: 30px; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            margin: 5px;
        }
        .main-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .section-title {
            font-size: 1.8em;
            color: #333;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #764ba2;
        }
        .thread-states {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        .state-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s;
            border: 3px solid transparent;
        }
        .state-card.active {
            border-color: #764ba2;
            background: linear-gradient(135deg, #e8eaf6 0%, #f3e5f5 100%);
            transform: scale(1.05);
        }
        .state-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        .state-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.2em;
        }
                .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            font-size: 0.95em;
            line-height: 1.4;
            white-space: pre;
            text-align: left;
            overflow-x: auto;
            tab-size: 4;
            position: relative;
        }
        .code-block::before {
            content: attr(data-lang);
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 0.75em;
            color: #6272a4;
            font-weight: bold;
            text-transform: uppercase;
        }
        .keyword { color: #ff79c6; }
        .type { color: #8be9fd; }
        .method { color: #50fa7b; }
        .comment { color: #6272a4; }
        .string { color: #f1fa8c; }
        .thread-visualization {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        .thread-box {
            flex: 1;
            min-width: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            position: relative;
        }
        .thread-name {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        .thread-progress {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .thread-progress-bar {
            height: 100%;
            background: #50fa7b;
            width: 0%;
            transition: width 0.5s;
        }
        .jmm-diagram {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }
        .memory-row {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            align-items: center;
            margin: 20px 0;
        }
        .memory-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #667eea;
        }
        .memory-box h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .sync-demo {
            background: linear-gradient(135deg, #40c463 0%, #30a14e 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }
        .lock-visualization {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 15px;
        }
        .lock-item {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            min-width: 150px;
        }
        .lock-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        .info-box {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #17a2b8;
        }
        .info-box.warning { background: #fff3cd; border-color: #ffc107; }
        .info-box.success { background: #d4edda; border-color: #28a745; }
        .info-box.info { background: #d1ecf1; border-color: #17a2b8; }
    
        /* è¨€èªåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .language-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        #language-selector {
            padding: 10px 15px;
            border-radius: 25px;
            border: 2px solid white;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1em;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            font-weight: bold;
        }

        #language-selector:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        #language-selector option {
            background: #764ba2;
            color: white;
        }
    
        /* Prism.js code block styling */
        pre {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            overflow-x: auto;
        }

        pre code {
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.8;
            text-align: left;
        }
</style>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown.min.css">

    <!-- Prism.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
</head>
<body>
    <!-- è¨€èªåˆ‡ã‚Šæ›¿ãˆ -->
    <div class="language-switcher">
        <select id="language-selector" onchange="window.langSwitcher.changeLanguage(this.value)">
            <option value="zh">ä¸­æ–‡</option>
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="en">English</option>
        </select></div>


    <div class="container">
        <a href="../index.html" class="back-btn animate__animated animate__fadeIn">â† è¿”å›ä¸»é¡µ</a>
        <div class="header animate__animated animate__fadeInDown">
            <h1>ğŸ”€ <span data-i18n="concurrencyTitle">å¤šçº¿ç¨‹ä¸å¹¶å‘</span></h1>
            <p>æ·±å…¥ç†è§£Javaå¹¶å‘ç¼–ç¨‹ä¸JMM</p></div>
        <div class="control-panel animate__animated animate__fadeIn">
            <button class="btn" onclick="demonstrateThreadStates()">ğŸ”„ çº¿ç¨‹çŠ¶æ€è½¬æ¢</button>
            <button class="btn" onclick="demonstrateThreads()">ğŸ§µ å¤šçº¿ç¨‹æ‰§è¡Œ</button>
            <button class="btn" onclick="reset()">ğŸ”„ é‡ç½®</button></div>
        <div class="main-content animate__animated animate__fadeInUp">
            <h2 class="section-title">ğŸ”„ çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸä¸çŠ¶æ€è½¬æ¢</h2>
            <div class="thread-states" id="threadStates">
                <div class="state-card" data-state="new">
                    <div class="state-icon">ğŸ†•</div>
                    <div class="state-name">NEW</div>
                    <p>çº¿ç¨‹å·²åˆ›å»ºä½†æœªå¯åŠ¨</p></div>
                <div class="state-card" data-state="runnable">
                    <div class="state-icon">â–¶ï¸</div>
                    <div class="state-name">RUNNABLE</div>
                    <p>å¯è¿è¡ŒçŠ¶æ€(å°±ç»ª/è¿è¡Œ)</p></div>
                <div class="state-card" data-state="blocked">
                    <div class="state-icon">ğŸ”’</div>
                    <div class="state-name">BLOCKED</div>
                    <p>ç­‰å¾…è·å–é”</p></div>
                <div class="state-card" data-state="waiting">
                    <div class="state-icon">â¸ï¸</div>
                    <div class="state-name">WAITING</div>
                    <p>æ— é™æœŸç­‰å¾…</p></div>
                <div class="state-card" data-state="timed_waiting">
                    <div class="state-icon">â±ï¸</div>
                    <div class="state-name">TIMED_WAITING</div>
                    <p>é™æ—¶ç­‰å¾…</p></div>
                <div class="state-card" data-state="terminated">
                    <div class="state-icon">âœ…</div>
                    <div class="state-name">TERMINATED</div>
                    <p>çº¿ç¨‹æ‰§è¡Œå®Œæ¯•</p></div></div>

            <div class="markdown-body">
                    <pre><code class="language-java">public class ThreadLifecycle {
    public static void main(String[] args) {
        Thread t = new Thread(() -> {
            try {
                Thread.sleep(1000);  // TIMED_WAITING
            } catch (InterruptedException e) {}
        });

        System.out.println(t.getState());  // NEW
        t.start();
        System.out.println(t.getState());  // RUNNABLE
    }
}</code></pre>
                </div>

            <h2 class="section-title">ğŸ§µ å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œ</h2>
            <div class="thread-visualization" id="threadViz">
                <div class="thread-box">
                    <div class="thread-name">Thread-1</div>
                    <div class="thread-progress">
                        <div class="thread-progress-bar" id="thread1"></div>
                    </div>
                    <p>çŠ¶æ€: <span id="state1">NEW</span></p></div>
                <div class="thread-box">
                    <div class="thread-name">Thread-2</div>
                    <div class="thread-progress">
                        <div class="thread-progress-bar" id="thread2"></div>
                    </div>
                    <p>çŠ¶æ€: <span id="state2">NEW</span></p></div>
                <div class="thread-box">
                    <div class="thread-name">Thread-3</div>
                    <div class="thread-progress">
                        <div class="thread-progress-bar" id="thread3"></div>
                    </div>
                    <p>çŠ¶æ€: <span id="state3">NEW</span></p></div></div>

            <h2 class="section-title">ğŸ§  Javaå†…å­˜æ¨¡å‹ (JMM)</h2>
            <div class="jmm-diagram">
                <h3 style="text-align: center; margin-bottom: 30px;">çº¿ç¨‹-ä¸»å†…å­˜äº¤äº’</h3>
                <div class="memory-row">
                    <div class="memory-box">
                        <h4>çº¿ç¨‹Aå·¥ä½œå†…å­˜</h4>
                        <p>å˜é‡å‰¯æœ¬</p>
                        <p>count = 10</p></div>
                    <div class="memory-box" style="border-color: #f5576c; background: linear-gradient(135deg, #fff5f7 0%, #ffebee 100%);">
                        <h4>ä¸»å†…å­˜ (å †)</h4>
                        <p>æ‰€æœ‰çº¿ç¨‹å…±äº«</p>
                        <p>count = 10</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">
                            â†•ï¸ read / write / lock / unlock
                        </p></div>
                    <div class="memory-box">
                        <h4>çº¿ç¨‹Bå·¥ä½œå†…å­˜</h4>
                        <p>å˜é‡å‰¯æœ¬</p>
                        <p>count = 10</p></div></div></div>

            <div class="info-box warning">
                <strong>âš ï¸ å¯è§æ€§é—®é¢˜ï¼š</strong><br>
                ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å˜é‡ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½æ— æ³•ç«‹å³çœ‹åˆ°ä¿®æ”¹ã€‚<br>
                è§£å†³æ–¹æ¡ˆ: ä½¿ç”¨ <code>volatile</code>ã€<code>synchronized</code> æˆ– <code>Lock</code></div>

            <h2 class="section-title">ğŸ”’ åŒæ­¥æœºåˆ¶</h2>

            <div class="sync-demo">
                <h3 style="margin-bottom: 20px;">synchronizedå…³é”®å­—</h3>
                <div class="markdown-body">
                    <pre><code class="language-java">public class Counter {
    private int count = 0;

    // åŒæ­¥æ–¹æ³•
    public synchronized void increment() {
        count++;
    }

    // åŒæ­¥ä»£ç å—
    public void add(int value) {
        synchronized(this) {
            count += value;
        }
    }
}</code></pre>
                </div></div>

            <div class="lock-visualization">
                <div class="lock-item">
                    <div class="lock-icon">ğŸ”“</div>
                    <h4>æ— é” / åå‘é”</h4>
                    <p>æ€§èƒ½æœ€ä¼˜</p></div>
                <div class="lock-icon" style="font-size: 2em;">â†’</div>
                <div class="lock-item">
                    <div class="lock-icon">ğŸ”</div>
                    <h4>è½»é‡çº§é”</h4>
                    <p>CASè‡ªæ—‹</p></div>
                <div class="lock-icon" style="font-size: 2em;">â†’</div>
                <div class="lock-item">
                    <div class="lock-icon">ğŸ”’</div>
                    <h4>é‡é‡çº§é”</h4>
                    <p>æ“ä½œç³»ç»Ÿäº’æ–¥é‡</p></div></div>

            <h2 class="section-title">âš¡ volatileå…³é”®å­—</h2>
            <div class="markdown-body">
                    <pre><code class="language-java">public class VolatileDemo {
    private volatile boolean flag = true;

    public void run() {
        while(flag) {  // ä¿è¯å¯è§æ€§
            // do something
        }
    }

    public void stop() {
        flag = false;  // ä¿®æ”¹ç«‹å³å¯¹å…¶ä»–çº¿ç¨‹å¯è§
    }
}</code></pre>
                </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div class="info-box success">
                    <strong>âœ… volatileä¿è¯ï¼š</strong><br>
                    â€¢ å¯è§æ€§: å†™æ“ä½œç«‹å³åˆ·æ–°åˆ°ä¸»å†…å­˜<br>
                    â€¢ æœ‰åºæ€§: ç¦æ­¢æŒ‡ä»¤é‡æ’åº<br>
                    â€¢ è½»é‡çº§: ä¸ä¼šå¼•èµ·çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</div>
                <div class="info-box warning">
                    <strong>âŒ volatileä¸ä¿è¯ï¼š</strong><br>
                    â€¢ åŸå­æ€§: count++ ä¸æ˜¯åŸå­æ“ä½œ<br>
                    â€¢ å¤åˆæ“ä½œçš„çº¿ç¨‹å®‰å…¨<br>
                    â€¢ éœ€è¦åŸå­æ€§ç”¨AtomicInteger</div></div>

            <h2 class="section-title">ğŸ› ï¸ å¹¶å‘å·¥å…·ç±»</h2>
            <div class="markdown-body">
                    <pre><code class="language-java">import java.util.concurrent.*;

// 1. ReentrantLock - å¯é‡å…¥é”
ReentrantLock lock = new ReentrantLock();
lock.lock();
try {
    // ä¸´ç•ŒåŒºä»£ç 
} finally {
    lock.unlock();
}

// 2. CountDownLatch - å€’è®¡æ—¶é—¨æ “
CountDownLatch latch = new CountDownLatch(3);
latch.countDown();
latch.await();  // ç­‰å¾…è®¡æ•°å½’é›¶

// 3. CyclicBarrier - å¾ªç¯å±éšœ
CyclicBarrier barrier = new CyclicBarrier(3);
barrier.await();  // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾

// 4. Semaphore - ä¿¡å·é‡
Semaphore semaphore = new Semaphore(5);
semaphore.acquire();  // è·å–è®¸å¯
semaphore.release();  // é‡Šæ”¾è®¸å¯

// 5. ThreadPoolExecutor - çº¿ç¨‹æ± 
ExecutorService executor = Executors.newFixedThreadPool(10);
executor.submit(() -> {
    System.out.println("Task executing");
});</code></pre>
                </div>

            <h2 class="section-title">ğŸ¯ happens-beforeåŸåˆ™</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                <div class="info-box info">
                    <strong>1ï¸âƒ£ ç¨‹åºé¡ºåºè§„åˆ™</strong><br>
                    å•çº¿ç¨‹å†…ï¼ŒæŒ‰ä»£ç é¡ºåºæ‰§è¡Œ</div>
                <div class="info-box info">
                    <strong>2ï¸âƒ£ volatileå˜é‡è§„åˆ™</strong><br>
                    å†™æ“ä½œ happens-before åç»­è¯»</div>
                <div class="info-box info">
                    <strong>3ï¸âƒ£ é”è§„åˆ™</strong><br>
                    unlock happens-before lock</div>
                <div class="info-box info">
                    <strong>4ï¸âƒ£ çº¿ç¨‹å¯åŠ¨è§„åˆ™</strong><br>
                    start() happens-before çº¿ç¨‹å†…æ“ä½œ</div>
                <div class="info-box info">
                    <strong>5ï¸âƒ£ çº¿ç¨‹ç»ˆæ­¢è§„åˆ™</strong><br>
                    çº¿ç¨‹å†…æ“ä½œ happens-before join()</div>
                <div class="info-box info">
                    <strong>6ï¸âƒ£ ä¼ é€’æ€§</strong><br>
                    A hb B, B hb C â†’ A hb C</div></div>

            <div class="info-box success" style="margin-top: 30px;">
                <strong>ğŸ’¡ æœ€ä½³å®è·µï¼š</strong><br>
                â€¢ ä¼˜å…ˆä½¿ç”¨java.util.concurrentåŒ…ä¸‹çš„å¹¶å‘å·¥å…·<br>
                â€¢ å‡å°‘é”çš„ç²’åº¦å’ŒæŒæœ‰æ—¶é—´<br>
                â€¢ ä½¿ç”¨çº¿ç¨‹æ± ç®¡ç†çº¿ç¨‹,é¿å…é¢‘ç¹åˆ›å»ºé”€æ¯<br>
                â€¢ ç†è§£happens-beforeè§„åˆ™,æ­£ç¡®ä½¿ç”¨volatile<br>
                â€¢ é¿å…æ­»é”: å›ºå®šåŠ é”é¡ºåºã€ä½¿ç”¨tryLockã€è¶…æ—¶æœºåˆ¶</div></div>
    </div>
    <script>
        const states = ['new', 'runnable', 'blocked', 'waiting', 'timed_waiting', 'terminated'];
        let currentStateIndex = 0;

        async function demonstrateThreadStates() {
            const cards = document.querySelectorAll('.state-card');
            cards.forEach(c => c.classList.remove('active'));

            for(let i = 0; i < states.length; i++) {
                cards[i].classList.add('active', 'animate__animated', 'animate__pulse');
                await sleep(1000);
                cards[i].classList.remove('animate__pulse');
            }
        }

        async function demonstrateThreads() {
            const threads = [
                { bar: document.getElementById('thread1'), state: document.getElementById('state1') },
                { bar: document.getElementById('thread2'), state: document.getElementById('state2') },
                { bar: document.getElementById('thread3'), state: document.getElementById('state3') }
            ];

            threads.forEach(t => {
                t.bar.style.width = '0%';
                t.state.textContent = 'RUNNABLE';
            });

            const intervals = threads.map((t, i) => {
                let progress = 0;
                return setInterval(() => {
                    progress += Math.random() * 10;
                    if(progress >= 100) {
                        progress = 100;
                        t.state.textContent = 'TERMINATED';
                        clearInterval(intervals[i]);
                    }
                    t.bar.style.width = progress + '%';
                }, 200 + i * 100);
            });
        }

        function reset() {
            document.querySelectorAll('.state-card').forEach(c => {
                c.classList.remove('active', 'animate__animated', 'animate__pulse');
            });
            document.querySelectorAll('.thread-progress-bar').forEach(b => {
                b.style.width = '0%';
            });
            ['state1', 'state2', 'state3'].forEach(id => {
                document.getElementById(id).textContent = 'NEW';
            });
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        window.addEventListener('load', () => {
            setTimeout(() => demonstrateThreadStates(), 1000);
        });
    </script>
</body>
</html>